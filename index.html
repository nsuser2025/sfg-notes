<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Sum Frequency Generation Spectroscopy Primer</title>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
    MathJax = {
        tex: {
            // インライン数式デリミタ: $...$ と \(...\) を有効化
            inlineMath: [['$','$'], ['\\(','\\)']],
            processEscapes: true, // バックスラッシュのエスケープ処理
            tags: "ams",          // 数式ナンバリングをAMS形式に設定
            autoload: {
                color: [],
                colorV2: ['color']
            },
            packages: {'[+]': ['noerrors']} // エラー発生時に元のコードを表示
        },
        chtml: {
            matchFontHeight: false,
            displayAlign: "left", // ブロック数式を左揃え
            displayIndent: "2em"  // 左揃えのインデント
        },
        options: {
            // レガシーな <script type="math/tex"> の処理。
            renderActions: {
                find_script_mathtex: [10, function (doc) {
                    for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                        const display = !!node.type.match(/; *mode=display/);
                        const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                        const text = document.createTextNode('');
                        node.parentNode.replaceChild(text, node);
                        math.start = {node: text, delim: '', n: 0};
                        math.end = {node: text, delim: '', n: 0};
                        doc.math.push(math);
                    }
                }, '']
            }
        },
        loader: {
            load: ['[tex]/noerrors']
        }
    };
</script>

<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script"></script>

<style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #note-container { 
        border: 1px solid #ccc; 
        padding: 15px; 
        margin-top: 20px; 
        background-color: #f9f9f9;
        min-height: 200px; /* 見やすいように最低限の高さを確保 */
    }
</style>
</head>
<body>

<h1>SFG Primer</h1>

<label for="chapter-select">Note number:</label>
<select id="chapter-select" onchange="loadMarkdown(this.value)">
    <option value="" disabled selected>--- 選択してください ---</option>
    <option value="notes/chapter1.md">第1章：線形感受率</option>
    <option value="notes/chapter2.md">第2章：非線形光学</option>
    <option value="notes/chapter3.md">第3章：フーリエ変換</option>
</select>

<div id="note-container">
    <p>ファイルを選択すると、ここに内容が表示されます。</p>
</div>

<script>
    // Marked.js のオプション設定
    marked.setOptions({
        breaks: true,
        gfm: true,
        // sanitize: false はセキュリティリスクのため、使用しない
    });

    /**
     * 指定されたMarkdownファイルを読み込み、HTMLに変換し、MathJaxで数式をレンダリングして表示する
     * @param {string} filePath - 読み込むMarkdownファイルへのパス (例: 'notes/chapter1.md')
     */
    function loadMarkdown(filePath) {
        if (!filePath) return;

        const container = document.getElementById('note-container');
        container.innerHTML = '<p>ファイル読み込み中...</p>'; // 読み込み中のメッセージ

        fetch(filePath)
            .then(res => {
                if (!res.ok) {
                    // HTTPエラー（404など）が発生した場合
                    throw new Error(`ファイルの読み込みに失敗しました: ${res.status} ${res.statusText}`);
                }
                return res.text();
            })
            .then(text => {
                // 1. MarkdownをHTMLに変換
                container.innerHTML = marked.parse(text); 
                
                // 2. MathJaxによる数式レンダリングを実行
                // MathJax.typesetPromiseを実行することで、変換後のHTML内の数式が処理されます
                MathJax.typesetPromise([container]); 
            })
            .catch(err => {
                console.error('Markdown 読み込み失敗:', err);
                container.innerHTML = 
                    `<p style="color: red;"><strong>エラー: ノートの読み込みに失敗しました。</strong></p>
                     <p>エラー詳細: ${err.message}</p>
                     <p>ファイルパス <code>${filePath}</code> が正しいか確認してください。</p>`;
            });
    }
</script>

</body>
</html>
